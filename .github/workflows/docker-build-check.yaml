name: Docker Build Check

on:
  pull_request:
    paths:
      # API image dependencies
      - 'actix-api/**'
      - 'videocall-types/**'
      - 'protobuf/**'
      - 'Dockerfile.actix'
      - 'Cargo.lock'
      - 'Cargo.toml'
      # UI image dependencies
      - 'yew-ui/**'
      - 'videocall-client/**'
      - 'videocall-codecs/**'
      - 'neteq/**'
      - 'Dockerfile.yew'
      - 'nginx.conf'
      - 'flake.nix'
      - 'flake.lock'
      # Meeting API dependencies
      - 'meeting-api/**'
      - 'videocall-meeting-types/**'
      - 'Dockerfile.meeting-api'
      # Docker directory changes
      - 'docker/Dockerfile.actix.dev'
      - 'docker/Dockerfile.yew.dev'
      - 'docker/start-yew.sh'
      # Website image dependencies
      - 'leptos-website/**'
      - 'docker/Dockerfile.website'

jobs:
  build-api:
    name: Build API Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.actix
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-meeting-api:
    name: Build Meeting API Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Meeting API Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.meeting-api
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ui:
    name: Build UI Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build UI Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.yew
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-website:
    name: Build Website Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Website Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.website
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

