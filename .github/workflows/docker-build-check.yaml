name: Docker Build Check

on:
  pull_request:
    paths:
      # API image dependencies
      - 'actix-api/**'
      - 'videocall-types/**'
      - 'protobuf/**'
      - 'Dockerfile.actix'
      - 'Cargo.lock'
      - 'Cargo.toml'
      # UI image dependencies
      - 'yew-ui/**'
      - 'videocall-client/**'
      - 'videocall-codecs/**'
      - 'neteq/**'
      - 'Dockerfile.yew'
      - 'nginx.conf'
      # Meeting API dependencies
      - 'meeting-api/**'
      - 'videocall-meeting-types/**'
      - 'Dockerfile.meeting-api'
      # Docker directory changes
      - 'docker/Dockerfile.actix'
      - 'docker/Dockerfile.yew'
      - 'docker/start-yew.sh'
      # Workflow changes (test workflow modifications)
      - '.github/workflows/docker-build-check.yaml'
      - '.github/workflows/pr-build-images-command.yaml'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-api:
    name: Build API Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.actix
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-meeting-api:
    name: Build Meeting API Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Meeting API Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.meeting-api
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ui:
    name: Build UI Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build UI Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.yew
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  comment:
    name: Comment on PR
    needs: [build-api, build-meeting-api, build-ui]
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Docker images build successfully!**

            All Docker images compiled without errors. Images were validated but not pushed to registry.

            **To push images to GHCR**, a maintainer must comment \`/build-images\` after reviewing the changes.

            Once images are pushed, you can deploy a preview environment with \`/deploy\` (coming soon).`
            })

