name: Docker Build Check

on:
  pull_request:
    paths:
      # API image dependencies
      - 'actix-api/**'
      - 'videocall-types/**'
      - 'protobuf/**'
      - 'Dockerfile.actix'
      - 'Cargo.lock'
      - 'Cargo.toml'
      # UI image dependencies
      - 'yew-ui/**'
      - 'videocall-client/**'
      - 'videocall-codecs/**'
      - 'neteq/**'
      - 'Dockerfile.yew'
      - 'nginx.conf'
      # Meeting API dependencies
      - 'meeting-api/**'
      - 'videocall-meeting-types/**'
      - 'Dockerfile.meeting-api'
      # Docker directory changes
      - 'docker/Dockerfile.actix'
      - 'docker/Dockerfile.yew'
      - 'docker/start-yew.sh'

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  build-api:
    name: Build API Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.actix
          push: true
          tags: ghcr.io/security-union/videocall-media-server:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-meeting-api:
    name: Build Meeting API Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Meeting API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.meeting-api
          push: true
          tags: ghcr.io/security-union/videocall-meeting-api:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ui:
    name: Build UI Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push UI Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.yew
          push: true
          tags: ghcr.io/security-union/videocall-web-ui:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  comment:
    name: Comment on PR with image tags
    needs: [build-api, build-meeting-api, build-ui]
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **PR images built successfully!**

            Images pushed to GitHub Container Registry:
            - \`ghcr.io/security-union/videocall-media-server:pr-${prNumber}\`
            - \`ghcr.io/security-union/videocall-meeting-api:pr-${prNumber}\`
            - \`ghcr.io/security-union/videocall-web-ui:pr-${prNumber}\`

            Comment \`/deploy\` to create a preview environment (coming soon).`
            })

