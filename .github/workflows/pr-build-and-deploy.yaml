name: Build and Deploy PR Preview

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  packages: write
  pull-requests: write
  issues: write

jobs:
  check-permissions:
    name: Check permissions
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/build-and-deploy')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      pr_number: ${{ steps.get-pr.outputs.pr_number }}
      pr_sha: ${{ steps.get-pr.outputs.pr_sha }}
      pr_ref: ${{ steps.get-pr.outputs.pr_ref }}
    steps:
      - name: Get PR details
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('pr_number', context.issue.number);
            core.setOutput('pr_sha', pr.data.head.sha);
            core.setOutput('pr_ref', pr.data.head.ref);
            return pr.data;

      - name: Check if user is maintainer
        id: check
        run: |
          ASSOCIATION="${{ github.event.comment.author_association }}"
          echo "User association: $ASSOCIATION"
          if [[ "$ASSOCIATION" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]]; then
            echo "‚úÖ User is authorized"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå User is not authorized"
            echo "authorized=false" >> $GITHUB_OUTPUT
          fi

      - name: React to comment (processing)
        if: steps.check.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Comment build-and-deploy started
        if: steps.check.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Building images and deploying preview...**

            Started by @${{ github.event.comment.user.login }}

            **Phase 1: Building Docker images** (~10-15 min)
            - Media Server (WebSocket/WebTransport)
            - Meeting API (REST backend)
            - Web UI (WASM frontend)

            **Phase 2: Deploying preview** (~3-5 min)
            - Creating namespace \`preview-${{ steps.get-pr.outputs.pr_number }}\`
            - Deploying services

            ‚è±Ô∏è Total time: ~15-20 minutes

            [View workflow run ‚Üí](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })

      - name: Post error if unauthorized
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const association = '${{ github.event.comment.author_association }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Permission denied**

            @${{ github.event.comment.user.login }}, only repository maintainers can trigger builds and deployments.

            **Your role**: \`${association}\`
            **Required roles**: \`OWNER\`, \`MEMBER\`, or \`COLLABORATOR\``
            })

      - name: Fail if unauthorized
        if: steps.check.outputs.authorized == 'false'
        run: exit 1

  build-images:
    name: Build Docker images
    needs: check-permissions
    if: needs.check-permissions.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: media-server
            dockerfile: Dockerfile.actix
            image: videocall-media-server
          - name: meeting-api
            dockerfile: Dockerfile.meeting-api
            image: videocall-meeting-api
          - name: web-ui
            dockerfile: Dockerfile.yew
            image: videocall-web-ui
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-permissions.outputs.pr_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ghcr.io/jboyd01/${{ matrix.image }}:pr-${{ needs.check-permissions.outputs.pr_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  comment-build-complete:
    name: Comment build complete
    needs: [check-permissions, build-images]
    runs-on: ubuntu-latest
    steps:
      - name: Comment images built
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-permissions.outputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Images built successfully!**

            üì¶ **Images pushed to GHCR:**
            - \`ghcr.io/jboyd01/videocall-media-server:pr-${prNumber}\`
            - \`ghcr.io/jboyd01/videocall-meeting-api:pr-${prNumber}\`
            - \`ghcr.io/jboyd01/videocall-web-ui:pr-${prNumber}\`

            üöÄ **Starting deployment...**`
            });

  deploy:
    name: Deploy preview environment
    needs: [check-permissions, build-images]
    if: needs.check-permissions.outputs.authorized == 'true'
    uses: ./.github/workflows/pr-deploy-reusable.yaml
    with:
      pr_number: ${{ needs.check-permissions.outputs.pr_number }}
      pr_sha: ${{ needs.check-permissions.outputs.pr_sha }}
      comment_id: ${{ github.event.comment.id }}
    secrets:
      DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
