name: Build PR Images (Command)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  packages: write
  pull-requests: write
  issues: write

jobs:
  check-permissions:
    name: Check permissions
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/build-images')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      pr_number: ${{ steps.get-pr.outputs.pr_number }}
      pr_sha: ${{ steps.get-pr.outputs.pr_sha }}
      pr_ref: ${{ steps.get-pr.outputs.pr_ref }}
    steps:
      - name: Get PR details
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('pr_number', context.issue.number);
            core.setOutput('pr_sha', pr.data.head.sha);
            core.setOutput('pr_ref', pr.data.head.ref);
            core.setOutput('pr_repo', pr.data.head.repo.full_name);
            return pr.data;

      - name: Check if user is maintainer
        id: check
        run: |
          ASSOCIATION="${{ github.event.comment.author_association }}"
          echo "User association: $ASSOCIATION"
          if [[ "$ASSOCIATION" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]]; then
            echo "✅ User is authorized"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "❌ User is not authorized"
            echo "authorized=false" >> $GITHUB_OUTPUT
          fi

      - name: React to comment (processing)
        if: steps.check.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            })

      - name: Post error if unauthorized
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const association = '${{ github.event.comment.author_association }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Permission denied**

            @${{ github.event.comment.user.login }}, only repository maintainers can trigger image builds.

            **Your role**: \`${association}\`
            **Required roles**: \`OWNER\`, \`MEMBER\`, or \`COLLABORATOR\`

            If you believe this is an error, please ask a maintainer to run \`/build-images\` after reviewing your changes.`
            })

      - name: React to comment (unauthorized)
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            })

      - name: Fail if unauthorized
        if: steps.check.outputs.authorized == 'false'
        run: exit 1

  build-api:
    name: Build API Docker image
    needs: check-permissions
    if: needs.check-permissions.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-permissions.outputs.pr_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.actix
          push: true
          tags: ghcr.io/security-union/videocall-media-server:pr-${{ needs.check-permissions.outputs.pr_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-meeting-api:
    name: Build Meeting API Docker image
    needs: check-permissions
    if: needs.check-permissions.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-permissions.outputs.pr_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Meeting API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.meeting-api
          push: true
          tags: ghcr.io/security-union/videocall-meeting-api:pr-${{ needs.check-permissions.outputs.pr_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ui:
    name: Build UI Docker image
    needs: check-permissions
    if: needs.check-permissions.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-permissions.outputs.pr_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push UI Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.yew
          push: true
          tags: ghcr.io/security-union/videocall-web-ui:pr-${{ needs.check-permissions.outputs.pr_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  comment-success:
    name: Comment with image tags
    needs: [check-permissions, build-api, build-meeting-api, build-ui]
    if: needs.check-permissions.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: React to comment (success)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Comment on PR with image tags
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-permissions.outputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **PR images built successfully!**

            Triggered by @${{ github.event.comment.user.login }}

            Images pushed to GitHub Container Registry:
            - \`ghcr.io/security-union/videocall-media-server:pr-${prNumber}\`
            - \`ghcr.io/security-union/videocall-meeting-api:pr-${prNumber}\`
            - \`ghcr.io/security-union/videocall-web-ui:pr-${prNumber}\`

            To pull locally:
            \`\`\`bash
            docker pull ghcr.io/security-union/videocall-media-server:pr-${prNumber}
            docker pull ghcr.io/security-union/videocall-meeting-api:pr-${prNumber}
            docker pull ghcr.io/security-union/videocall-web-ui:pr-${prNumber}
            \`\`\`

            Comment \`/deploy\` to create a preview environment (coming soon).`
            })

  comment-failure:
    name: Comment on failure
    needs: [check-permissions, build-api, build-meeting-api, build-ui]
    if: |
      always() &&
      needs.check-permissions.outputs.authorized == 'true' &&
      (needs.build-api.result == 'failure' || needs.build-meeting-api.result == 'failure' || needs.build-ui.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: React to comment (failure)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            })

      - name: Comment on failure
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-permissions.outputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Image build failed**

            One or more images failed to build. Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            Build results:
            - API: ${{ needs.build-api.result }}
            - Meeting API: ${{ needs.build-meeting-api.result }}
            - UI: ${{ needs.build-ui.result }}`
            })
