name: Undeploy PR Preview

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-permissions:
    name: Check permissions
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/undeploy')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      pr_number: ${{ steps.get-pr.outputs.pr_number }}
    steps:
      - name: Get PR details
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('pr_number', context.issue.number);

      - name: Check if user is maintainer
        id: check
        run: |
          ASSOCIATION="${{ github.event.comment.author_association }}"
          echo "User association: $ASSOCIATION"
          if [[ "$ASSOCIATION" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]]; then
            echo "✅ User is authorized"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "❌ User is not authorized"
            echo "authorized=false" >> $GITHUB_OUTPUT
          fi

      - name: React to comment (processing)
        if: steps.check.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            })

      - name: Post error if unauthorized
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const association = '${{ github.event.comment.author_association }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Permission denied**

            @${{ github.event.comment.user.login }}, only repository maintainers can undeploy preview environments.

            **Your role**: \`${association}\`
            **Required roles**: \`OWNER\`, \`MEMBER\`, or \`COLLABORATOR\``
            })

      - name: Fail if unauthorized
        if: steps.check.outputs.authorized == 'false'
        run: exit 1

  undeploy:
    name: Undeploy preview environment
    needs: check-permissions
    if: needs.check-permissions.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Configure kubectl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Setup kubectl context
        run: |
          doctl kubernetes cluster kubeconfig save videocall-us-east

      - name: Check if preview exists
        id: check-preview
        run: |
          PR_NUM=${{ needs.check-permissions.outputs.pr_number }}
          NAMESPACE="preview-${PR_NUM}"

          if kubectl get namespace ${NAMESPACE} >/dev/null 2>&1; then
            echo "Preview environment exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Preview environment does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete namespace
        if: steps.check-preview.outputs.exists == 'true'
        run: |
          PR_NUM=${{ needs.check-permissions.outputs.pr_number }}
          NAMESPACE="preview-${PR_NUM}"

          echo "Deleting namespace: ${NAMESPACE}"
          kubectl delete namespace ${NAMESPACE} --ignore-not-found=true

          echo "✅ Namespace deleted (includes NATS and all services)"

      - name: Drop postgres database
        if: steps.check-preview.outputs.exists == 'true'
        run: |
          PR_NUM=${{ needs.check-permissions.outputs.pr_number }}
          DB_NAME="preview_${PR_NUM}"

          echo "Dropping database: ${DB_NAME}"

          # Get postgres password from secret
          PG_PASSWORD=$(kubectl get secret postgres-credentials -n default -o jsonpath='{.data.password}' | base64 -d)

          # Drop database
          kubectl exec -n default postgres-postgresql-0 -- \
            env PGPASSWORD="${PG_PASSWORD}" psql -U postgres -c "DROP DATABASE IF EXISTS ${DB_NAME};" || {
              echo "⚠️  Failed to drop database, may need manual cleanup"
            }

          echo "✅ Database dropped"

      - name: Delete GHCR images
        if: steps.check-preview.outputs.exists == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-permissions.outputs.pr_number }};
            const packages = [
              'videocall-media-server',
              'videocall-meeting-api',
              'videocall-web-ui'
            ];

            for (const packageName of packages) {
              try {
                // Get package versions
                const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                  package_type: 'container',
                  package_name: packageName,
                  org: context.repo.owner
                });

                // Find the pr-{NUM} tagged version
                const prTag = `pr-${prNumber}`;
                const targetVersion = versions.data.find(v =>
                  v.metadata?.container?.tags?.includes(prTag)
                );

                if (targetVersion) {
                  await github.rest.packages.deletePackageVersionForOrg({
                    package_type: 'container',
                    package_name: packageName,
                    org: context.repo.owner,
                    package_version_id: targetVersion.id
                  });
                  console.log(`✅ Deleted ${packageName}:${prTag}`);
                } else {
                  console.log(`⚠️  Image ${packageName}:${prTag} not found`);
                }
              } catch (error) {
                console.log(`⚠️  Failed to delete ${packageName}: ${error.message}`);
              }
            }

      - name: React to comment (success)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'hooray'
            })

      - name: Post success comment
        if: steps.check-preview.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-permissions.outputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **PR preview environment undeployed**

            Cleaned up by @${{ github.event.comment.user.login }}

            **Resources removed:**
            - Namespace \`preview-${prNumber}\` (includes all pods and services)
            - Database \`preview_${prNumber}\`
            - GHCR images tagged \`pr-${prNumber}\`

            You can redeploy by commenting \`/deploy\` again.`
            })

      - name: Post not-found comment
        if: steps.check-preview.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-permissions.outputs.pr_number }};
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ℹ️ **No preview environment found**

            There is no active preview environment for PR #${prNumber}.

            To deploy one, comment \`/deploy\`.`
            })
