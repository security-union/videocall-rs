FROM securityunion/yew:1.72-slim

# Install nginx
RUN apt-get update \
    && apt-get install -y nginx \
    && rm -rf /var/lib/apt/lists/*

# Set default environment variables (can be overridden by K8s)
ENV ENABLE_OAUTH=false
ENV LOGIN_URL=""
ENV ACTIX_UI_BACKEND_URL="wss://api.rustlemania.com"
ENV WEBTRANSPORT_HOST="https://transport.rustlemania.com"
ENV WEBTRANSPORT_ENABLED="true"
ENV E2EE_ENABLED="false"
ENV USERS_ALLOWED_TO_STREAM=""
ENV UI_URL="https://app.videocall.rs"

WORKDIR /app
COPY . .
WORKDIR /app/yew-ui

# Ensure wasm target is available
RUN rustup target add wasm32-unknown-unknown

# Pre-install dependencies to speed up runtime compilation
# This will fail but installs dependencies
RUN cargo check --release || true

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Copy and make startup script executable
COPY start-yew.sh /app/
RUN chmod +x /app/start-yew.sh

# Use the startup script that compiles at runtime
CMD ["/app/start-yew.sh"]
