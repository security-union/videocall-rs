# US East Matomo configuration using Bitnami chart
  # Regional deployment configuration for matomo.videocall.rs
matomo:
  # Service configuration - ensure ClusterIP only (not LoadBalancer)
  service:
    type: ClusterIP

  # Ingress configuration for US East - use shared ingress controller
  ingress:
    enabled: true
    ingressClassName: "nginx"
    annotations:
      cert-manager.io/issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/use-forwarded-headers: "true"
      nginx.ingress.kubernetes.io/enable-real-ip: "true"
      nginx.ingress.kubernetes.io/proxy-real-ip-cidr: "0.0.0.0/0"
    hostname: "matomo.videocall.rs"
    path: "/"
    pathType: Prefix
    tls: true

  # Matomo application configuration (using correct Bitnami schema)
  matomoUsername: "admin"
  matomoPassword: ""  # Auto-generate secure password
  matomoEmail: "admin@videocall.rs"
  matomoWebsiteName: "VideoCall Analytics"
  matomoWebsiteHost: "https://videocall.rs"
  
  # Environment variables for real IP support (Bitnami standard)
  extraEnvVars:
    - name: MATOMO_ASSUME_SECURE_PROTOCOL
      value: "1"
    - name: MATOMO_FORCE_SSL
      value: "1"

  # Custom post-init script to configure Matomo for real IP (Bitnami standard)
  customPostInitScripts:
    matomo-realip-config.php: |
      <?php
      // Configure Matomo to trust proxy headers for real IP detection
      $configFile = '/bitnami/matomo/config/config.ini.php';
      $config = array(
          '[General]',
          'proxy_client_headers[] = HTTP_X_FORWARDED_FOR',
          'proxy_client_headers[] = HTTP_X_REAL_IP', 
          'proxy_client_headers[] = HTTP_CF_CONNECTING_IP',
          'proxy_host_headers[] = HTTP_X_FORWARDED_HOST',
          'assume_secure_protocol = 1',
          'force_ssl = 1'
      );
      
      if (file_exists($configFile)) {
          $content = file_get_contents($configFile);
          $configText = implode(PHP_EOL, $config);
          if (strpos($content, 'proxy_client_headers[]') === false) {
              $content = str_replace('[PluginsInstalled]', $configText . PHP_EOL . PHP_EOL . '[PluginsInstalled]', $content);
              file_put_contents($configFile, $content);
              echo "Real IP configuration added to Matomo config\n";
          }
      }

  # MariaDB configuration - auto-generate passwords
  mariadb:
    enabled: true
    auth:
      # Leave passwords empty to auto-generate secure random passwords
      rootPassword: ""
      database: "bitnami_matomo"
      username: "bn_matomo"
      password: ""

  # Resources (increased for analytics load)
  resources:
    limits:
      cpu: 500m
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 1Gi

  # Persistence configuration
  persistence:
    enabled: true
    size: 10Gi