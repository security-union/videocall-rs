# US East Meeting API configuration
meeting-api:
  nameOverride: "meeting-api-us-east"
  fullnameOverride: "meeting-api-us-east"

  replicaCount: 1

  image:
    repository: securityunion/videocall-meeting-api
    pullPolicy: Always
    tag: latest

  env:
    - name: RUST_LOG
      value: info
    - name: LISTEN_ADDR
      value: "0.0.0.0:8081"
    - name: PG_PASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres-credentials
          key: password
    - name: DATABASE_URL
      value: postgres://postgres:$(PG_PASSWORD)@postgres-postgresql:5432/actix-api-db?sslmode=disable
    - name: JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: jwt-secret
          key: secret
    - name: TOKEN_TTL_SECS
      value: "86400"
    - name: SESSION_TTL_SECS
      value: "315360000"
    - name: COOKIE_SECURE
      value: "true"
    - name: COOKIE_DOMAIN
      value: ".videocall.rs"
    - name: CORS_ALLOWED_ORIGIN
      value: "https://app.videocall.rs"
    - name: OAUTH_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: google-oauth-credentials
          key: client-id
    - name: OAUTH_SECRET
      valueFrom:
        secretKeyRef:
          name: google-oauth-credentials
          key: client-secret
    - name: OAUTH_REDIRECT_URL
      value: "https://api.videocall.rs/login/callback"
    - name: AFTER_LOGIN_URL
      value: "https://app.videocall.rs"

  resources:
    limits:
      cpu: "200m"
      memory: "256Mi"
    requests:
      cpu: "100m"
      memory: "128Mi"

  service:
    type: ClusterIP
    port: 8081

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      kubernetes.io/tls-acme: "true"
    hosts:
      - host: api.videocall.rs
        paths:
          - path: /
            pathType: Prefix
            service:
              name: meeting-api-us-east
              port:
                number: 8081
    tls:
      - secretName: api-videocall-rs-tls
        hosts:
          - api.videocall.rs

  # Node selector for US East region
  nodeSelector:
    topology.kubernetes.io/region: "nyc1"

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - meeting-api-us-east
          topologyKey: kubernetes.io/hostname
