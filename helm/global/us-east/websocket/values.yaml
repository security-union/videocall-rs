# US East WebSocket server configuration
rustlemania-websocket:
  nameOverride: "websocket-us-east"
  fullnameOverride: "websocket-us-east"

  replicaCount: 1  # Higher replicas for primary region

  image:
    repository: securityunion/videocall-media-server
    pullPolicy: Always
    tag: latest

  env:
    - name: RUST_LOG
      value: warn
    - name: ACTIX_PORT
      value: "8080"
    - name: NATS_URL
      value: nats-us-east:4222  # Connect to US East NATS cluster
    - name: REGION
      value: "us-east"
    - name: HOSTNAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: SERVER_ID
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: SERVICE_TYPE
      value: websocket
    - name: SERVER_STATS_INTERVAL_SECS
      value: "5"
    - name: TOKIO_WORKER_THREADS
      value: "2"  # Optimal for 2400m CPU (I/O bound WebSocket operations)
    - name: JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: jwt-secret
          key: secret


  resources:
    limits:
      cpu: "2200m"
      memory: "4000Mi"
    requests:
      cpu: "2200m"
      memory: "4000Mi"

  service:
    type: ClusterIP  # Changed to ClusterIP for ingress
    port: 8080

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      kubernetes.io/tls-acme: "true"
    hosts:
      - host: websocket-us-east.webtransport.video
        paths:
          - path: /
            pathType: Prefix
            service:
              name: websocket-us-east
              port:
                number: 8080
    tls:
      - secretName: websocket-us-east-tls
        hosts:
          - websocket-us-east.webtransport.video
          - webtransport-us-east.webtransport.video

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 12
    targetCPUUtilizationPercentage: 70

  # Node selector for US East region
  nodeSelector:
    topology.kubernetes.io/region: "nyc1"

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - websocket-us-east
          topologyKey: kubernetes.io/hostname 